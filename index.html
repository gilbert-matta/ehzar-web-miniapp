<!DOCTYPE html>
<html>
  <head>
    <base href="/" />
    <meta charset="UTF-8" />
    <meta content="IE=Edge" http-equiv="X-UA-Compatible" />
    <meta name="description" content="Ihzar SuperQi Integration" />

    <!-- iOS meta tags & icons -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="apple-mobile-web-app-title" content="ihzar" />
    <link rel="apple-touch-icon" href="icons/Icon-192.png" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <link rel="manifest" href="manifest.json" />
    <title>Ihzar</title>

    <!-- ✅ load before Flutter -->
    <script src="https://cdn.marmot-cloud.com/npm/hylid-bridge/2.10.0/index.js"></script>

    <!-- QI NEO Payment Handler -->
    <script src="js/qi_neo_payment.js"></script>

    <!-- Google reCAPTCHA v3 -->
    <script src="https://www.google.com/recaptcha/api.js?render=6LdahBEsAAAAACU5XKjZqhMMyqT4F2e8YCQ63k2e"></script>

    <!-- reCAPTCHA Handler -->
    <script src="js/recaptcha_handler.js"></script>

    <script>
      console.log("✅ Injecting SuperQiAuth bridge...");
      window.superQiAuth = {
        async getAuthCodeAndToken(BASE_URL) {
          console.log("[Bridge] Initialized ✅");
          return new Promise((resolve, reject) => {
            function startAuth() {
              console.log("[Bridge] Ready:", typeof my.getAuthCode);
              if (typeof my === "undefined") {
                console.error("`my` object missing. Not in SuperQi environment?");
                reject("Not running inside SuperQi.");
                return;
              }
              my.getAuthCode({
                scopes: ["auth_user", "USER_ID"],
                success: async (res) => {
                  console.log("[Bridge] Auth code:", res.authCode);
                  const endpoint = `${BASE_URL}v1/auth/apply-token`;
                  try {
                    const resp = await fetch(endpoint, {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ auth_code: res.authCode }),
                    });
                    const data = await resp.json();
                    console.log("[Bridge] Backend response:", data);
                    
                    // Add status field if missing and ensure proper format
                    const responseData = {
                      ...data,
                      status: data.status || 'success',
                      statusCode: resp.status
                    };
                    
                    console.log("[Bridge] Formatted response:", responseData);
                    resolve(responseData);
                  } catch (err) {
                    console.error("[Bridge] applyToken error:", err);
                    
                    // Return consistent error format instead of rejecting
                    const errorResponse = {
                      status: 'error',
                      statusCode: 400,
                      message: err.message || err.toString(),
                      user: null,
                      token: null
                    };
                    
                    resolve(errorResponse);
                  }
                },
                fail: (err) => {
                  console.error("[Bridge] getAuthCode failed:", err);
                  reject(err);
                },
              });
            }

            if (typeof my === "undefined" || !my.getAuthCode) {
              console.log("[Bridge] Waiting for AlipayJSBridgeReady...");
              document.addEventListener("AlipayJSBridgeReady", startAuth, false);
            } else {
              startAuth();
            }
          });
        },
      };
      console.log("✅ window.superQiAuth defined");
    </script>
  </head>

  <body>
    <!-- Flutter app loads AFTER the bridge -->
    <script src="flutter_bootstrap.js" async></script>
  </body>
</html>
